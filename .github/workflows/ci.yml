name: CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Build
      run: go build -v ./...

    - name: Test
      env:
        STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
        STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
        STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        DOMAIN: ${{ secrets.DOMAIN }}
      run: go test -v ./...

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          DOMAIN: ${{ secrets.DOMAIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
            echo "Syncing environment variables to Render..."
            # Construct JSON payload
            # Note: This replaces all existing env vars on the service!
            DATA="[{\"key\":\"STRIPE_SECRET_KEY\",\"value\":\"$STRIPE_SECRET_KEY\"},{\"key\":\"STRIPE_PUBLISHABLE_KEY\",\"value\":\"$STRIPE_PUBLISHABLE_KEY\"},{\"key\":\"STRIPE_PRICE_ID\",\"value\":\"$STRIPE_PRICE_ID\"},{\"key\":\"STRIPE_WEBHOOK_SECRET\",\"value\":\"$STRIPE_WEBHOOK_SECRET\"},{\"key\":\"DOMAIN\",\"value\":\"$DOMAIN\"},{\"key\":\"DATABASE_URL\",\"value\":\"$DATABASE_URL\"}]"
            
            curl -X PUT "https://api.render.com/v1/services/$RENDER_SERVICE_ID/env-vars" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$DATA" \
              --fail
          fi

          if [ -n "$RENDER_DEPLOY_HOOK" ]; then
            echo "Triggering deployment via Hook..."
            curl -X POST $RENDER_DEPLOY_HOOK
          elif [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
             echo "Triggering deployment via API..."
             curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
               -H "Authorization: Bearer $RENDER_API_KEY" \
               --fail
          else
            echo "No deployment method available."
            exit 1
          fi
