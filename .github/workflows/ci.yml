name: CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Build
      run: go build -v ./...

    - name: Test
      env:
        STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
        STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
        STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        DOMAIN: ${{ secrets.DOMAIN }}
      run: go test -v ./...

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          DOMAIN: ${{ secrets.DOMAIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CSRF_AUTH_KEY: ${{ secrets.CSRF_AUTH_KEY }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          echo "Checking for Render credentials..."
          if [ -n "$RENDER_API_KEY" ]; then echo "RENDER_API_KEY is set"; else echo "RENDER_API_KEY is NOT set"; fi
          if [ -n "$RENDER_SERVICE_ID" ]; then echo "RENDER_SERVICE_ID is set"; else echo "RENDER_SERVICE_ID is NOT set"; fi

          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
            echo "Syncing environment variables to Render..."
            
            # Create JSON payload safely using jq
            # Start with required vars
            ENV_VARS=$(jq -n \
              --arg sk "$STRIPE_SECRET_KEY" \
              --arg pk "$STRIPE_PUBLISHABLE_KEY" \
              --arg pid "$STRIPE_PRICE_ID" \
              --arg wh "$STRIPE_WEBHOOK_SECRET" \
              --arg dom "$DOMAIN" \
              --arg db "$DATABASE_URL" \
              --arg csrf "$CSRF_AUTH_KEY" \
              --arg sess "$SESSION_SECRET" \
              '[
                {key: "STRIPE_SECRET_KEY", value: $sk},
                {key: "STRIPE_PUBLISHABLE_KEY", value: $pk},
                {key: "STRIPE_PRICE_ID", value: $pid},
                {key: "STRIPE_WEBHOOK_SECRET", value: $wh},
                {key: "DOMAIN", value: $dom},
                {key: "DATABASE_URL", value: $db},
                {key: "CSRF_AUTH_KEY", value: $csrf},
                {key: "SESSION_SECRET", value: $sess}
              ]')
            
            # Add R2 vars only if they are set
            if [ -n "$R2_ACCOUNT_ID" ]; then
              ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_ACCOUNT_ID" '. += [{key: "R2_ACCOUNT_ID", value: $v}]')
            fi
            if [ -n "$R2_ACCESS_KEY_ID" ]; then
              ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_ACCESS_KEY_ID" '. += [{key: "R2_ACCESS_KEY_ID", value: $v}]')
            fi
            if [ -n "$R2_SECRET_ACCESS_KEY" ]; then
              ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_SECRET_ACCESS_KEY" '. += [{key: "R2_SECRET_ACCESS_KEY", value: $v}]')
            fi
            if [ -n "$R2_BUCKET_NAME" ]; then
              ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_BUCKET_NAME" '. += [{key: "R2_BUCKET_NAME", value: $v}]')
            fi
            if [ -n "$R2_PUBLIC_URL" ]; then
              ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_PUBLIC_URL" '. += [{key: "R2_PUBLIC_URL", value: $v}]')
            fi
            
            echo "$ENV_VARS" > env_vars.json

            curl -X PUT "https://api.render.com/v1/services/$RENDER_SERVICE_ID/env-vars" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d @env_vars.json \
              --fail
          else
            echo "Skipping env var sync because RENDER_API_KEY or RENDER_SERVICE_ID is missing."
          fi

          # Prefer API method since it's more reliable
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
             echo "Triggering deployment via API..."
             echo "Service ID: $RENDER_SERVICE_ID"
             curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
               -H "Authorization: Bearer $RENDER_API_KEY" \
               -H "Accept: application/json" \
               -H "Content-Type: application/json" \
               --fail -v
          elif [ -n "$RENDER_DEPLOY_HOOK" ]; then
            echo "Triggering deployment via Hook..."
            curl "$RENDER_DEPLOY_HOOK" --fail
          else
            echo "No deployment method available."
            echo "RENDER_DEPLOY_HOOK is set: $([ -n \"$RENDER_DEPLOY_HOOK\" ] && echo 'yes' || echo 'no')"
            echo "RENDER_API_KEY is set: $([ -n \"$RENDER_API_KEY\" ] && echo 'yes' || echo 'no')"
            echo "RENDER_SERVICE_ID is set: $([ -n \"$RENDER_SERVICE_ID\" ] && echo 'yes' || echo 'no')"
            exit 1
          fi
