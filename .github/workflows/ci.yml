name: CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Build
      run: go build -v ./...

    - name: Test
      env:
        STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
        STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
        STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        DOMAIN: ${{ secrets.DOMAIN }}
      run: go test -v ./...

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          DOMAIN: ${{ secrets.DOMAIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CSRF_AUTH_KEY: ${{ secrets.CSRF_AUTH_KEY }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "Missing RENDER_API_KEY or RENDER_SERVICE_ID"
            exit 1
          fi

          # Sync environment variables to Render
          ENV_VARS=$(jq -n \
            --arg sk "$STRIPE_SECRET_KEY" \
            --arg pk "$STRIPE_PUBLISHABLE_KEY" \
            --arg pid "$STRIPE_PRICE_ID" \
            --arg wh "$STRIPE_WEBHOOK_SECRET" \
            --arg dom "$DOMAIN" \
            --arg db "$DATABASE_URL" \
            --arg csrf "$CSRF_AUTH_KEY" \
            --arg sess "$SESSION_SECRET" \
            '[
              {key: "STRIPE_SECRET_KEY", value: $sk},
              {key: "STRIPE_PUBLISHABLE_KEY", value: $pk},
              {key: "STRIPE_PRICE_ID", value: $pid},
              {key: "STRIPE_WEBHOOK_SECRET", value: $wh},
              {key: "DOMAIN", value: $dom},
              {key: "DATABASE_URL", value: $db},
              {key: "CSRF_AUTH_KEY", value: $csrf},
              {key: "SESSION_SECRET", value: $sess}
            ]')
          
          # Add R2 vars only if set
          [ -n "$R2_ACCOUNT_ID" ] && ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_ACCOUNT_ID" '. += [{key: "R2_ACCOUNT_ID", value: $v}]')
          [ -n "$R2_ACCESS_KEY_ID" ] && ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_ACCESS_KEY_ID" '. += [{key: "R2_ACCESS_KEY_ID", value: $v}]')
          [ -n "$R2_SECRET_ACCESS_KEY" ] && ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_SECRET_ACCESS_KEY" '. += [{key: "R2_SECRET_ACCESS_KEY", value: $v}]')
          [ -n "$R2_BUCKET_NAME" ] && ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_BUCKET_NAME" '. += [{key: "R2_BUCKET_NAME", value: $v}]')
          [ -n "$R2_PUBLIC_URL" ] && ENV_VARS=$(echo "$ENV_VARS" | jq --arg v "$R2_PUBLIC_URL" '. += [{key: "R2_PUBLIC_URL", value: $v}]')
          
          echo "$ENV_VARS" > env_vars.json
          curl -X PUT "https://api.render.com/v1/services/$RENDER_SERVICE_ID/env-vars" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @env_vars.json --fail

          # Trigger deployment
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" --fail
